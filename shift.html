<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bartending Shift Tracker</title>
    <style>
        /* Design System - Tailwind Inspired */
        * { 
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            /* Colors */
            --purple-gradient-start: #667eea;
            --purple-gradient-end: #764ba2;
            --gray-gradient-start: #2c3e50;
            --gray-gradient-end: #34495e;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --green-500: #10b981;
            --green-600: #059669;
            --red-500: #ef4444;
            --red-600: #dc2626;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--purple-gradient-start) 0%, var(--purple-gradient-end) 100%);
            min-height: 100vh;
            padding: 1.25rem;
            color: var(--gray-900);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--gray-gradient-start) 0%, var(--gray-gradient-end) 100%);
            color: var(--white);
            padding: 1.5rem 2rem;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .content {
            padding: 2rem;
            display: flex;
            gap: 2rem;
        }
        
        .main-content {
            flex: 1;
        }
        
        .preview-panel {
            width: 350px;
            background: var(--gray-50);
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            height: fit-content;
            position: sticky;
            top: 2rem;
            display: none;
        }
        
        .preview-panel.active {
            display: block;
        }
        
        .preview-panel h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 1rem;
        }
        
        .preview-item {
            margin-bottom: 0.75rem;
        }
        
        .preview-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        
        .preview-value {
            font-size: 1rem;
            color: var(--gray-800);
            font-weight: 500;
        }
        
        .categories-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }
        
        .category-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .category-card:hover {
            background: var(--gray-50);
            border-color: var(--blue-500);
            box-shadow: var(--shadow);
        }
        
        .category-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: var(--blue-50);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blue-600);
            flex-shrink: 0;
        }
        
        .category-info {
            flex: 1;
        }
        
        .category-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }
        
        .category-description {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .autocomplete-wrapper {
            position: relative;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gray-300);
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: var(--shadow-md);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .autocomplete-dropdown.active {
            display: block;
        }
        
        .autocomplete-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background 0.1s;
        }
        
        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--gray-100);
        }
        
        .autocomplete-item.selected {
            background: var(--blue-50);
            color: var(--blue-700);
        }
        
        tr.selected {
            background-color: var(--blue-50) !important;
            outline: 2px solid var(--blue-500);
            outline-offset: -2px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary {
            background-color: var(--blue-500);
            color: var(--white);
            border-color: var(--blue-500);
        }

        .btn-primary:hover {
            background-color: var(--blue-600);
        }

        .btn-icon {
            width: 1rem;
            height: 1rem;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-icon {
            width: 2.5rem;
            height: 2.5rem;
            margin: 0 auto 0.75rem;
            color: var(--gray-600);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .btn-danger {
            background-color: var(--red-500);
            color: var(--white);
            border-color: var(--red-500);
        }

        .btn-danger:hover {
            background-color: var(--red-600);
        }

        .btn-edit {
            background-color: var(--amber-500);
            color: var(--white);
            border: none;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-edit:hover {
            background-color: var(--amber-600);
        }

        .btn-delete {
            background-color: var(--red-500);
            color: var(--white);
            border: none;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--gray-200);
            background: var(--white);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }

        th {
            background: linear-gradient(135deg, var(--gray-gradient-start) 0%, var(--gray-gradient-end) 100%);
            color: var(--white);
            padding: 0.875rem 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.875rem;
            color: var(--gray-900);
        }

        tr:hover {
            background-color: var(--gray-50);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 0;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--gray-gradient-start) 0%, var(--gray-gradient-end) 100%);
            color: var(--white);
            padding: 1.25rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .close {
            color: var(--white);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: opacity 0.2s ease;
            background: transparent;
            border: none;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
        }

        .close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.375rem;
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background-color: var(--white);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            background: var(--gray-50);
            border-radius: 0 0 0.5rem 0.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            border-top: 1px solid var(--gray-200);
        }

        .btn-secondary {
            background: var(--gray-500);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--gray-600);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .currency {
            color: var(--green-600);
            font-weight: 600;
        }

        .hours {
            color: var(--blue-600);
            font-weight: 600;
        }

        .error-message {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border: 1px solid #fecaca;
            font-size: 0.875rem;
        }

        .success-message {
            background-color: #d1fae5;
            color: #065f46;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border: 1px solid #a7f3d0;
            font-size: 0.875rem;
        }

        .debug-info {
            background-color: var(--gray-50);
            padding: 1rem;
            border-radius: 0.375rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.75rem;
            border: 1px solid var(--gray-200);
            display: none;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            th, td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }

            .actions {
                flex-direction: column;
                gap: 0.25rem;
            }

            .btn-edit, .btn-delete {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>
                    <svg class="btn-icon" style="width: 1.5rem; height: 1.5rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Bartending Shift Tracker
                </h1>
                <p>Track your shifts, tips, and earnings</p>
            </div>
            <div class="nav-buttons">
                <button class="btn" onclick="navigateToPage('landing')" title="Back to Dashboard">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    Dashboard
                </button>
                <button class="btn" onclick="navigateToPage('employee')" title="Employee CRM">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    Employees
                </button>
            </div>
        </div>
        
        <div class="content">
            <div class="main-content">
                <div class="controls">
                <div>
                    <strong id="totalShifts">0 shifts tracked</strong>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" style="background: var(--blue-500); color: white; border-color: var(--blue-500);" onclick="loadShifts()">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh Data
                    </button>
                    <button class="btn btn-primary" style="background: var(--blue-500); color: white; border-color: var(--blue-500);" onclick="openAddModal()">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add New Shift
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-cards">
                <div class="stat-card">
                    <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="stat-value" id="totalTips">$0</div>
                    <div class="stat-label">Total Tips</div>
                </div>
                <div class="stat-card">
                    <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="stat-value" id="totalHours">0h</div>
                    <div class="stat-label">Total Hours</div>
                </div>
                <div class="stat-card">
                    <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <div class="stat-value" id="avgTipsPerHour">$0/hr</div>
                    <div class="stat-label">Average Tips/Hour</div>
                </div>
            </div>

            <div id="errorContainer"></div>
            <div id="successContainer"></div>

            <div class="debug-info" id="debugInfo">
                <h4>Debug Information:</h4>
                <div id="debugContent"></div>
            </div>

            <div class="loading" id="loading">
                <p>Loading shifts...</p>
            </div>

            <div class="table-container" id="tableContainer" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Hours</th>
                            <th>Location</th>
                            <th>Tips</th>
                            <th>Tips/Hour</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="shiftsTableBody">
                    </tbody>
                </table>
            </div>

            <div class="empty-state" id="emptyState" style="display: none;">
                <h3>No shifts tracked yet</h3>
                <p>Click "Add New Shift" to get started tracking your bartending shifts</p>
                <br>
                <button class="btn btn-primary" style="background: var(--blue-500); color: white; border-color: var(--blue-500);" onclick="testGoogleScript()">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    Test Connection
                </button>
            </div>
            </div>
            
            <!-- Preview Panel -->
            <div class="preview-panel" id="previewPanel">
                <h3>Shift Details</h3>
                <div id="previewContent">
                    <p style="color: var(--gray-500); text-align: center; padding: 2rem 0;">
                        Select a shift to view details
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Shift -->
    <div id="shiftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Shift</h2>
                <button class="close" onclick="closeModal()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="shiftForm">
                    <input type="hidden" id="shiftId" value="">
                    
                    <div class="form-group">
                        <label for="shiftDate">Date</label>
                        <input type="date" id="shiftDate" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="startTime">Start Time</label>
                            <input type="time" id="startTime" required>
                        </div>
                        <div class="form-group">
                            <label for="endTime">End Time</label>
                            <input type="time" id="endTime" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tips">Tips ($)</label>
                            <input type="number" id="tips" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="location" required autocomplete="off">
                                <div class="autocomplete-dropdown" id="locationDropdown"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" placeholder="Any additional notes about the shift..."></textarea>
                    </div>
                    
                    <!-- Categories Section -->
                    <div class="categories-section">
                        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Additional Information</h3>
                        
                        <div class="category-card" onclick="openCoworkersPage()">
                            <div class="category-icon">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                </svg>
                            </div>
                            <div class="category-info">
                                <div class="category-title">Coworkers</div>
                                <div class="category-description">Add team members who worked this shift</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn btn-primary" style="background: var(--blue-500); color: white; border-color: var(--blue-500);" onclick="saveShift()">Save Shift</button>
            </div>
        </div>
    </div>

    <script>
        let shifts = [];
        let editingShiftId = null;
        let isGoogleAppsScript = false;
        let selectedRowIndex = -1;
        let locations = [];
        let currentUser = null;
        let pageUrls = null;

        // Debug logging function - must be defined before use
        function debugLog(message) {
            const timestamp = new Date().toISOString();
            console.log('[SHIFT-DEBUG] 🔍 ' + timestamp + ': ' + message);
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 [SHIFT-INIT] ===============================');
            console.log('🚀 [SHIFT-INIT] Bartending Shift Tracker Loading');
            console.log('🚀 [SHIFT-INIT] ===============================');
            console.log('[SHIFT-INIT] ⏰ Load started at:', new Date().toISOString());
            console.log('[SHIFT-INIT] 📍 Page URL:', window.location.href);
            console.log('[SHIFT-INIT] 🌐 User Agent:', navigator.userAgent);
            console.log('[SHIFT-INIT] 📱 Viewport:', window.innerWidth + 'x' + window.innerHeight);
            
            // Check if we're running in Google Apps Script environment
            isGoogleAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);
            console.log('[SHIFT-INIT] 🔧 Google Apps Script available:', isGoogleAppsScript);
            console.log('[SHIFT-INIT] 🔧 Google object:', typeof google);
            console.log('[SHIFT-INIT] 🔧 Google.script object:', typeof google?.script);
            
            // Check essential DOM elements
            const essentialElements = ['shiftForm', 'shiftsTable', 'errorContainer', 'successContainer'];
            console.log('[SHIFT-INIT] 🏗️ Checking essential DOM elements...');
            essentialElements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`[SHIFT-INIT] 📋 Element '${id}':`, element ? '✅ Found' : '❌ Missing');
            });
            
            debugLog('App initialized. Google Apps Script available: ' + isGoogleAppsScript);
            console.log('[SHIFT-INIT] 📊 Loading shifts data...');
            loadShifts();
            loadLocations();
            loadCurrentUser();
            setupKeyboardNavigation();
            setupLocationAutocomplete();
        });

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = '<div class="error-message">' + message + '</div>';
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('successContainer');
            container.innerHTML = '<div class="success-message">' + message + '</div>';
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        function loadShifts() {
            console.log('[SHIFT-LOAD] 🔄 Starting shift data load...');
            console.log('[SHIFT-LOAD] ⏰ Load timestamp:', new Date().toISOString());
            console.log('[SHIFT-LOAD] 🔧 Google Apps Script mode:', isGoogleAppsScript);
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            debugLog('Starting loadShifts()');
            
            try {
                if (isGoogleAppsScript) {
                    console.log('[SHIFT-LOAD] 📡 Calling getAllShifts via Google Apps Script...');
                    debugLog('Calling getAllShifts via Google Apps Script');
                    google.script.run
                        .withSuccessHandler(function(data) {
                            console.log('[SHIFT-LOAD] ✅ getAllShifts success response:', data);
                            console.log('[SHIFT-LOAD] 📊 Shifts count:', Array.isArray(data) ? data.length : 'Not an array');
                            if (Array.isArray(data) && data.length > 0) {
                                console.log('[SHIFT-LOAD] 📋 Sample shift data:', data[0]);
                                console.log('[SHIFT-LOAD] 💰 Total tips:', data.reduce((sum, shift) => sum + (shift.tips || 0), 0));
                                console.log('[SHIFT-LOAD] ⏱️ Total hours:', data.reduce((sum, shift) => sum + (shift.hours || 0), 0));
                            }
                            debugLog('getAllShifts success: ' + JSON.stringify(data));
                            onShiftsLoaded(data);
                        })
                        .withFailureHandler(function(error) {
                            console.error('[SHIFT-LOAD] ❌ getAllShifts error:', error);
                            console.error('[SHIFT-LOAD] 📝 Error details:', {
                                message: error.message,
                                stack: error.stack,
                                name: error.name
                            });
                            debugLog('getAllShifts error: ' + JSON.stringify(error));
                            onError(error);
                        })
                        .getAllShifts();
                } else {
                    console.log('[SHIFT-LOAD] ⚠️ Google Apps Script not available, using mock data');
                    debugLog('Google Apps Script not available, using mock data');
                    // For testing purposes, use mock data
                    setTimeout(() => {
                        const mockData = [
                            {
                                id: 'mock1',
                                date: '2025-01-15',
                                startTime: '18:00',
                                endTime: '02:00',
                                hours: 8,
                                location: 'Downtown Bar',
                                tips: 150.75,
                                tipsPerHour: 18.84,
                                notes: 'Busy Friday night'
                            }
                        ];
                        console.log('[SHIFT-LOAD] 🧪 Loading mock data:', mockData);
                        onShiftsLoaded(mockData);
                    }, 1000);
                }
            } catch (error) {
                console.error('[SHIFT-LOAD] 🚨 Exception in loadShifts:', error);
                console.error('[SHIFT-LOAD] 📝 Exception stack:', error.stack);
                debugLog('Exception in loadShifts: ' + error.message);
                onError(error);
            }
        }

        function onShiftsLoaded(data) {
            debugLog('onShiftsLoaded called with data type: ' + typeof data);
            debugLog('Data is array: ' + Array.isArray(data));
            debugLog('Data length: ' + (data ? data.length : 'null/undefined'));
            
            // Ensure data is an array
            if (!Array.isArray(data)) {
                debugLog('Data is not an array, converting...');
                data = data ? [data] : [];
            }
            
            shifts = data;
            debugLog('Processed shifts array length: ' + shifts.length);
            
            document.getElementById('loading').style.display = 'none';
            
            if (shifts.length === 0) {
                debugLog('No shifts found, showing empty state');
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('tableContainer').style.display = 'none';
            } else {
                debugLog('Shifts found, rendering table');
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'block';
                renderShiftsTable();
            }
            
            updateStats();
        }

        function renderShiftsTable() {
            debugLog('Rendering table with ' + shifts.length + ' shifts');
            const tbody = document.getElementById('shiftsTableBody');
            tbody.innerHTML = '';

            shifts.forEach((shift, index) => {
                debugLog('Rendering shift ' + index + ': ' + JSON.stringify(shift));
                
                const row = tbody.insertRow();
                
                // Safely handle data that might be null/undefined
                const date = shift.date || '';
                const startTime = shift.startTime || '';
                const endTime = shift.endTime || '';
                const location = shift.location || '';
                const tips = parseFloat(shift.tips) || 0;
                const notes = shift.notes || '';
                
                // Calculate hours and tips per hour
                let hours = parseFloat(shift.hours) || 0;
                let tipsPerHour = parseFloat(shift.tipsPerHour) || 0;
                
                // Recalculate if not provided
                if (hours === 0 && startTime && endTime) {
                    const startDateTime = new Date(`${date}T${startTime}`);
                    const endDateTime = new Date(`${date}T${endTime}`);
                    
                    // Handle shifts that end past midnight
                    if (endDateTime < startDateTime) {
                        endDateTime.setDate(endDateTime.getDate() + 1);
                    }
                    
                    hours = (endDateTime - startDateTime) / (1000 * 60 * 60);
                    tipsPerHour = hours > 0 ? (tips / hours) : 0;
                }

                row.innerHTML = `
                    <td>${formatDate(date)}</td>
                    <td>${formatTime(startTime)}</td>
                    <td>${formatTime(endTime)}</td>
                    <td class="hours">${hours.toFixed(1)}h</td>
                    <td>${location}</td>
                    <td class="currency">$${tips.toFixed(2)}</td>
                    <td class="currency">$${tipsPerHour.toFixed(2)}</td>
                    <td>${notes || '-'}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-edit" onclick="editShift('${shift.id}')">
                                <svg style="width: 0.75rem; height: 0.75rem; display: inline-block; vertical-align: middle; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit
                            </button>
                            <button class="btn-delete" onclick="deleteShift('${shift.id}')">
                                <svg style="width: 0.75rem; height: 0.75rem; display: inline-block; vertical-align: middle; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Delete
                            </button>
                        </div>
                    </td>
                `;
            });
        }

        function updateStats() {
            const totalShifts = shifts.length;
            const totalTips = shifts.reduce((sum, shift) => sum + (parseFloat(shift.tips) || 0), 0);
            const totalHours = shifts.reduce((sum, shift) => sum + (parseFloat(shift.hours) || 0), 0);
            const avgTipsPerHour = totalHours > 0 ? (totalTips / totalHours) : 0;
            
            document.getElementById('totalShifts').innerHTML = 
                `${totalShifts} shift${totalShifts !== 1 ? 's' : ''} tracked`;
            
            document.getElementById('totalTips').textContent = `$${totalTips.toFixed(2)}`;
            document.getElementById('totalHours').textContent = `${totalHours.toFixed(1)}h`;
            document.getElementById('avgTipsPerHour').textContent = `$${avgTipsPerHour.toFixed(2)}/hr`;
        }

        function openAddModal() {
            editingShiftId = null;
            document.getElementById('modalTitle').textContent = 'Add New Shift';
            document.getElementById('shiftForm').reset();
            document.getElementById('shiftId').value = '';
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('shiftDate').value = today;
            
            document.getElementById('shiftModal').style.display = 'block';
        }

        function editShift(id) {
            debugLog('Editing shift with ID: ' + id);
            const shift = shifts.find(s => s.id === id);
            if (!shift) {
                showError('Shift not found');
                return;
            }

            editingShiftId = id;
            document.getElementById('modalTitle').textContent = 'Edit Shift';
            document.getElementById('shiftId').value = id;
            document.getElementById('shiftDate').value = shift.date;
            document.getElementById('startTime').value = shift.startTime;
            document.getElementById('endTime').value = shift.endTime;
            document.getElementById('tips').value = shift.tips;
            document.getElementById('location').value = shift.location;
            document.getElementById('notes').value = shift.notes || '';
            
            document.getElementById('shiftModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('shiftModal').style.display = 'none';
            editingShiftId = null;
        }

        function saveShift() {
            const form = document.getElementById('shiftForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const shiftData = {
                id: document.getElementById('shiftId').value || generateId(),
                date: document.getElementById('shiftDate').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                tips: parseFloat(document.getElementById('tips').value),
                location: document.getElementById('location').value,
                notes: document.getElementById('notes').value
            };

            debugLog('Saving shift: ' + JSON.stringify(shiftData));

            try {
                if (isGoogleAppsScript) {
                    const operation = editingShiftId ? 'updateShift' : 'addShift';
                    debugLog('Calling ' + operation + ' via Google Apps Script');
                    
                    google.script.run
                        .withSuccessHandler(function(result) {
                            debugLog('Save success: ' + JSON.stringify(result));
                            onShiftSaved();
                        })
                        .withFailureHandler(function(error) {
                            debugLog('Save error: ' + JSON.stringify(error));
                            onError(error);
                        })
                        [operation](shiftData);
                } else {
                    debugLog('Google Apps Script not available, simulating save');
                    // Add to local array for testing
                    if (editingShiftId) {
                        const index = shifts.findIndex(s => s.id === editingShiftId);
                        if (index !== -1) {
                            shifts[index] = shiftData;
                        }
                    } else {
                        shifts.push(shiftData);
                    }
                    setTimeout(() => onShiftSaved(), 500);
                }
            } catch (error) {
                debugLog('Exception in saveShift: ' + error.message);
                onError(error);
            }
        }

        function onShiftSaved() {
            debugLog('Shift saved successfully');
            showSuccess('Shift saved successfully!');
            closeModal();
            loadShifts();
        }

        function deleteShift(id) {
            if (confirm('Are you sure you want to delete this shift?')) {
                debugLog('Deleting shift: ' + id);
                
                try {
                    if (isGoogleAppsScript) {
                        google.script.run
                            .withSuccessHandler(function(result) {
                                debugLog('Delete success: ' + JSON.stringify(result));
                                onShiftDeleted();
                            })
                            .withFailureHandler(function(error) {
                                debugLog('Delete error: ' + JSON.stringify(error));
                                onError(error);
                            })
                            .deleteShift(id);
                    } else {
                        debugLog('Google Apps Script not available, simulating delete');
                        // Remove from local array for testing
                        shifts = shifts.filter(s => s.id !== id);
                        setTimeout(() => onShiftDeleted(), 500);
                    }
                } catch (error) {
                    debugLog('Exception in deleteShift: ' + error.message);
                    onError(error);
                }
            }
        }

        function onShiftDeleted() {
            debugLog('Shift deleted successfully');
            showSuccess('Shift deleted successfully!');
            loadShifts();
        }

        function onError(error) {
            debugLog('Error occurred: ' + JSON.stringify(error));
            const errorMessage = error.message || error.toString() || 'An unknown error occurred';
            showError('Error: ' + errorMessage);
            document.getElementById('loading').style.display = 'none';
        }

        function testGoogleScript() {
            debugLog('Testing Google Apps Script connection...');
            
            if (!isGoogleAppsScript) {
                showError('Google Apps Script not available in this environment');
                return;
            }

            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        debugLog('Test success: ' + JSON.stringify(result));
                        showSuccess('Connection successful! ' + JSON.stringify(result));
                        loadShifts();
                    })
                    .withFailureHandler(function(error) {
                        debugLog('Test error: ' + JSON.stringify(error));
                        showError('Connection failed: ' + (error.message || error.toString()));
                    })
                    .testSetup();
            } catch (error) {
                debugLog('Exception in testGoogleScript: ' + error.message);
                onError(error);
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (e) {
                return dateString;
            }
        }

        function formatTime(timeString) {
            if (!timeString) return '-';
            try {
                const [hours, minutes] = timeString.split(':');
                const date = new Date();
                date.setHours(parseInt(hours), parseInt(minutes));
                return date.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
            } catch (e) {
                return timeString;
            }
        }

        function generateId() {
            return 'shift_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('shiftModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Handle escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Enable debug mode with Ctrl+D
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'd') {
                event.preventDefault();
                toggleDebug();
            }
        });

        // Cache the URLs when page loads
        let pageUrls = null;
        
        // Load URLs on page initialization - add to existing initialization
        if (typeof google !== 'undefined' && google.script) {
            console.log('[SHIFT] 🔄 Loading navigation URLs from server...');
            google.script.run.withSuccessHandler(function(urls) {
                pageUrls = urls;
                console.log('[SHIFT] ✅ Navigation URLs loaded:', urls);
            }).withFailureHandler(function(error) {
                console.error('[SHIFT] ❌ Failed to load navigation URLs:', error);
            }).getPageUrls();
        }
        
        // Navigation function for page routing
        function navigateToPage(page) {
            console.log('[NAVIGATION] 🧭 Navigating from shift page to:', page);
            console.log('[NAVIGATION] 📍 Current URL:', window.location.href);
            
            // If URLs are cached, use them
            if (pageUrls && pageUrls[page]) {
                console.log('[NAVIGATION] 🎯 Using cached URL:', pageUrls[page]);
                try {
                    // Try to navigate the top window first (in case we're in an iframe)
                    if (window.top && window.top !== window) {
                        window.top.location.href = pageUrls[page];
                    } else {
                        window.location.href = pageUrls[page];
                    }
                } catch (e) {
                    // If top navigation fails, use regular navigation
                    window.location.href = pageUrls[page];
                }
                return;
            }
            
            // Otherwise, get URLs from server
            console.log('[NAVIGATION] 📡 Fetching URLs from server...');
            google.script.run.withSuccessHandler(function(urls) {
                console.log('[NAVIGATION] 📡 Got URLs from server:', urls);
                pageUrls = urls; // Cache for future use
                if (urls && urls[page]) {
                    try {
                        // Try to navigate the top window first (in case we're in an iframe)
                        if (window.top && window.top !== window) {
                            window.top.location.href = urls[page];
                        } else {
                            window.location.href = urls[page];
                        }
                    } catch (e) {
                        // If top navigation fails, use regular navigation
                        window.location.href = urls[page];
                    }
                } else {
                    console.error('[NAVIGATION] ❌ Invalid page:', page);
                }
            }).withFailureHandler(function(error) {
                console.error('[NAVIGATION] ❌ Failed to get URLs:', error);
                // Fallback to client-side navigation
                console.log('[NAVIGATION] 🔄 Using fallback navigation');
                const fallbackUrl = page === 'landing' ? '.' : '?page=' + page;
                window.location.href = fallbackUrl;
            }).getPageUrls();
        }
        
        // Load locations from Google Sheets
        function loadLocations() {
            if (isGoogleAppsScript) {
                google.script.run
                    .withSuccessHandler(function(data) {
                        locations = data || [];
                        debugLog('Loaded ' + locations.length + ' locations');
                    })
                    .withFailureHandler(function(error) {
                        debugLog('Error loading locations: ' + error);
                    })
                    .getLocationsList();
            } else {
                // Mock data for testing
                locations = ['Main Bar', 'Patio Bar', 'VIP Lounge', 'Downstairs Bar', 'Rooftop Bar'];
            }
        }
        
        // Load current user
        function loadCurrentUser() {
            if (isGoogleAppsScript) {
                google.script.run
                    .withSuccessHandler(function(user) {
                        currentUser = user;
                        debugLog('Current user: ' + (user ? user.name : 'Not found'));
                    })
                    .withFailureHandler(function(error) {
                        debugLog('Error loading current user: ' + error);
                    })
                    .getCurrentUser();
            }
        }
        
        // Setup keyboard navigation
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', function(e) {
                const tbody = document.getElementById('shiftsTableBody');
                if (!tbody || tbody.rows.length === 0) return;
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectRow(Math.min(selectedRowIndex + 1, tbody.rows.length - 1));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectRow(Math.max(selectedRowIndex - 1, 0));
                } else if (e.key === 'Enter' && selectedRowIndex >= 0) {
                    e.preventDefault();
                    const shift = shifts[selectedRowIndex];
                    if (shift) {
                        editShift(shift.id);
                    }
                } else if (e.key === 'Delete' && selectedRowIndex >= 0) {
                    e.preventDefault();
                    const shift = shifts[selectedRowIndex];
                    if (shift && confirm('Are you sure you want to delete this shift?')) {
                        deleteShift(shift.id);
                    }
                }
            });
        }
        
        // Select a row and show preview
        function selectRow(index) {
            const tbody = document.getElementById('shiftsTableBody');
            if (!tbody || index < 0 || index >= tbody.rows.length) return;
            
            // Remove previous selection
            tbody.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected'));
            
            // Add selection to new row
            selectedRowIndex = index;
            tbody.rows[index].classList.add('selected');
            tbody.rows[index].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Show preview
            showPreview(shifts[index]);
        }
        
        // Show shift preview
        function showPreview(shift) {
            if (!shift) return;
            
            const panel = document.getElementById('previewPanel');
            const content = document.getElementById('previewContent');
            
            panel.classList.add('active');
            
            content.innerHTML = `
                <div class="preview-item">
                    <div class="preview-label">Date</div>
                    <div class="preview-value">${formatDate(shift.date)}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Time</div>
                    <div class="preview-value">${shift.startTime} - ${shift.endTime}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Duration</div>
                    <div class="preview-value">${shift.hours} hours</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Location</div>
                    <div class="preview-value">${shift.location || 'Not specified'}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Tips</div>
                    <div class="preview-value" style="color: var(--green-600); font-size: 1.25rem;">$${parseFloat(shift.tips).toFixed(2)}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Tips per Hour</div>
                    <div class="preview-value" style="color: var(--blue-600);">$${parseFloat(shift.tipsPerHour).toFixed(2)}/hr</div>
                </div>
                ${shift.notes ? `
                <div class="preview-item">
                    <div class="preview-label">Notes</div>
                    <div class="preview-value" style="font-size: 0.875rem; color: var(--gray-600);">${shift.notes}</div>
                </div>
                ` : ''}
                
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
                    <button class="btn btn-primary" style="width: 100%; background: var(--blue-500); color: white; border-color: var(--blue-500);" onclick="editShift('${shift.id}')">
                        Edit Shift
                    </button>
                    <button class="btn" style="width: 100%; margin-top: 0.5rem; color: var(--red-600); border-color: var(--red-600);" onclick="if(confirm('Delete this shift?')) deleteShift('${shift.id}')">
                        Delete Shift
                    </button>
                </div>
            `;
        }
        
        // Setup location autocomplete
        function setupLocationAutocomplete() {
            const input = document.getElementById('location');
            const dropdown = document.getElementById('locationDropdown');
            let selectedIndex = -1;
            
            if (!input || !dropdown) return;
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                dropdown.innerHTML = '';
                selectedIndex = -1;
                
                if (value.length === 0) {
                    dropdown.classList.remove('active');
                    return;
                }
                
                const matches = locations.filter(loc => 
                    loc.toLowerCase().includes(value)
                );
                
                if (matches.length === 0) {
                    dropdown.classList.remove('active');
                    return;
                }
                
                dropdown.classList.add('active');
                matches.forEach((loc, index) => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = loc;
                    item.addEventListener('click', function() {
                        input.value = loc;
                        dropdown.classList.remove('active');
                    });
                    dropdown.appendChild(item);
                });
            });
            
            input.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateAutocompleteSelection(items, selectedIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateAutocompleteSelection(items, selectedIndex);
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    input.value = items[selectedIndex].textContent;
                    dropdown.classList.remove('active');
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('active');
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }
        
        function updateAutocompleteSelection(items, index) {
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('selected');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        // Format date for display
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }
        
        // Open coworkers page
        function openCoworkersPage() {
            const shiftId = document.getElementById('shiftId').value;
            if (!shiftId) {
                // For new shifts, save first then open coworkers
                showError('Please save the shift first before adding coworkers');
                return;
            }
            
            // Store current shift data
            const shiftData = {
                id: shiftId,
                date: document.getElementById('shiftDate').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                location: document.getElementById('location').value
            };
            
            sessionStorage.setItem('currentShift', JSON.stringify(shiftData));
            
            // Open coworkers page (this will be implemented as a separate modal/page)
            openCoworkersModal(shiftId);
        }
        
        // Open coworkers modal
        function openCoworkersModal(shiftId) {
            // Create a modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            // Create modal container
            const modalContainer = document.createElement('div');
            modalContainer.style.cssText = `
                width: 90%;
                max-width: 1200px;
                height: 90vh;
                background: white;
                border-radius: 0.75rem;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                position: relative;
            `;
            
            // Create close button
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '×';
            closeBtn.style.cssText = `
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 2rem;
                height: 2rem;
                border: none;
                background: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #6b7280;
                z-index: 10;
            `;
            closeBtn.onclick = function() {
                document.body.removeChild(modalOverlay);
                // Reload shifts to reflect any changes
                loadShifts();
            };
            
            // Create iframe
            const iframe = document.createElement('iframe');
            // Use appropriate URL based on environment
            if (isGoogleAppsScript && pageUrls && pageUrls.coworkers) {
                iframe.src = `${pageUrls.coworkers}&shiftId=${shiftId}`;
            } else {
                iframe.src = `coworkers.html?shiftId=${shiftId}`;
            }
            iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 0.75rem;
            `;
            
            // Pass data to iframe
            iframe.onload = function() {
                const shiftData = {
                    id: shiftId,
                    date: document.getElementById('shiftDate').value,
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value,
                    location: document.getElementById('location').value
                };
                
                // Try to pass data to iframe
                try {
                    iframe.contentWindow.postMessage({
                        type: 'shiftData',
                        data: shiftData
                    }, '*');
                } catch (e) {
                    console.log('Could not post message to iframe:', e);
                }
            };
            
            modalContainer.appendChild(closeBtn);
            modalContainer.appendChild(iframe);
            modalOverlay.appendChild(modalContainer);
            document.body.appendChild(modalOverlay);
            
            // Close on ESC key
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(modalOverlay);
                    document.removeEventListener('keydown', escHandler);
                    loadShifts();
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        // Update renderShiftsTable to enable row clicks
        function renderShiftsTableWithSelection() {
            const tbody = document.getElementById('shiftsTableBody');
            if (!tbody) return;
            
            tbody.querySelectorAll('tr').forEach((row, index) => {
                row.style.cursor = 'pointer';
                row.addEventListener('click', function() {
                    selectRow(index);
                });
            });
            
            // Select first row by default if there are shifts
            if (shifts.length > 0 && selectedRowIndex === -1) {
                selectRow(0);
            }
        }
        
        // Override the existing renderShiftsTable function
        const originalRenderShiftsTable = renderShiftsTable;
        renderShiftsTable = function() {
            originalRenderShiftsTable();
            renderShiftsTableWithSelection();
        };
    </script>
</body>
</html>